import pandas as pd
import matplotlib.pyplot as plt
from mplsoccer import Pitch

def PlotAllStealings(ax, df, hteamName, ateamName, hcol, acol, bg_color, line_color):
    """
    Visualizes all turnover events (stealings) on a soccer pitch with high-turnover zones highlighted.
    """
    pitch = Pitch(pitch_type='uefa', corner_arcs=True, pitch_color=bg_color, line_color=line_color, linewidth=2)
    pitch.draw(ax=ax)
    ax.set_ylim(-0.5, 68.5)
    ax.set_xlim(-0.5, 105.5)

    # Filter for 'stealings' events only
    stealings_events = df[df['event_type'] == 'stealings'].copy()

    # Separate data for home and away teams
    home_stealings = stealings_events[stealings_events['team_name'] == hteamName]
    away_stealings = stealings_events[stealings_events['team_name'] == ateamName]

    # Plot all stealings for the home team
    ax.scatter(home_stealings['x1_scaled'], home_stealings['y1_scaled'], s=100, color='None', edgecolor=hcol, zorder=2, label=hteamName)
    home_stealings_count = len(home_stealings)

    # Plot all stealings for the away team
    ax.scatter(away_stealings['x1_scaled'], away_stealings['y1_scaled'], s=100, color='None', edgecolor=acol, zorder=2, label=ateamName)
    away_stealings_count = len(away_stealings)

    # Add colored areas for visualization purposes
    left_circle = plt.Circle((0,34), 40, color=hcol, fill=True, alpha=0.25)
    ax.add_artist(left_circle)
    right_circle = plt.Circle((105,34), 40, color=acol, fill=True, alpha=0.25)
    ax.add_artist(right_circle)

    # Set the aspect ratio to be equal
    ax.set_aspect('equal', adjustable='box')

    # Headlines and other texts
    ax.text(0, 70, f"{hteamName}\nRobos Totales: {home_stealings_count}", color=hcol, size=25, ha='left', fontweight='bold')
    ax.text(105, 70, f"{ateamName}\nRobos Totales: {away_stealings_count}", color=acol, size=25, ha='right', fontweight='bold')
    ax.text(0, -3, '<---Dirección de Ataque', color=hcol, fontsize=13, ha='left', va='center')
    ax.text(105, -3, 'Dirección de Ataque--->', color=acol, fontsize=13, ha='right', va='center')

    return {
        'Home_Team_Name': hteamName,
        'Home_Total_Stealings': home_stealings_count,
        'Away_Team_Name': ateamName,
        'Away_Total_Stealings': away_stealings_count
    }

if __name__ == '__main__':
    bg_color = '#FFFFFF'
    line_color = '#000000'
    hteamName = 'Argentina'
    hcol = 'blue'
    ateamName = 'Venezuela'
    acol = 'red'

    file_path = '/Users/gustavoortiz/Downloads/stealings.csv'

    try:
        df = pd.read_csv(file_path)

        # Scale coordinates from [-1, 1] to [0, 105] for x and [0, 68] for y
        df['x1_scaled'] = (df['x1'] + 1) * 52.5
        df['y1_scaled'] = (df['y1'] + 1) * 34

        fig, ax = plt.subplots(figsize=(10, 10), facecolor=bg_color)
        stealings_stats = PlotAllStealings(ax, df, hteamName, ateamName, hcol, acol, bg_color, line_color)
        plt.show()
        print("Stealings Stats:", stealings_stats)

    except FileNotFoundError:
        print(f"Error: The file '{file_path}' was not found.")
    except KeyError as e:
        print(f"Error: Missing column {e}. Please ensure your CSV has the required headers.")
